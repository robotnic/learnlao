"use strict";(self.webpackChunklearnlao=self.webpackChunklearnlao||[]).push([[878],{1531:(O,N,M)=>{M.d(N,{db:()=>c});var u=M(631);const c=new class l extends u.Ay{constructor(){super("LaoLearningDB"),this.version(1).stores({vocab:"id, category, usage_rank, english",progress:"id, due, state, [state+due]"})}}},3560:(O,N,M)=>{M.d(N,{$F:()=>ht,GW:()=>l,O_:()=>L,Uw:()=>u});var u=(n=>(n[n.New=0]="New",n[n.Learning=1]="Learning",n[n.Review=2]="Review",n[n.Relearning=3]="Relearning",n))(u||{}),l=(n=>(n[n.Manual=0]="Manual",n[n.Again=1]="Again",n[n.Hard=2]="Hard",n[n.Good=3]="Good",n[n.Easy=4]="Easy",n))(l||{});class c{static card(t){return{...t,state:c.state(t.state),due:c.time(t.due),last_review:t.last_review?c.time(t.last_review):void 0}}static rating(t){if("string"==typeof t){const e=t.charAt(0).toUpperCase(),i=t.slice(1).toLowerCase(),s=l[`${e}${i}`];if(void 0===s)throw new Error(`Invalid rating:[${t}]`);return s}if("number"==typeof t)return t;throw new Error(`Invalid rating:[${t}]`)}static state(t){if("string"==typeof t){const e=t.charAt(0).toUpperCase(),i=t.slice(1).toLowerCase(),s=u[`${e}${i}`];if(void 0===s)throw new Error(`Invalid state:[${t}]`);return s}if("number"==typeof t)return t;throw new Error(`Invalid state:[${t}]`)}static time(t){const e=new Date(t);if("object"==typeof t&&null!==t&&!Number.isNaN(Date.parse(t)||+e))return e;if("string"==typeof t){const i=Date.parse(t);if(Number.isNaN(i))throw new Error(`Invalid date:[${t}]`);return new Date(i)}if("number"==typeof t)return new Date(t);throw new Error(`Invalid date:[${t}]`)}static review_log(t){return{...t,due:c.time(t.due),rating:c.rating(t.rating),state:c.state(t.state),review:c.time(t.review)}}}function m(n,t,e){return new Date(e?c.time(n).getTime()+24*t*60*60*1e3:c.time(n).getTime()+60*t*1e3)}function x(n,t,e){if(!n||!t)throw new Error("Invalid date");const i=c.time(n).getTime()-c.time(t).getTime();let s=0;switch(e){case"days":s=Math.floor(i/864e5);break;case"minutes":s=Math.floor(i/6e4)}return s}function v(n){return n<10?`0${n}`:`${n}`}Date.prototype.scheduler=function(n,t){return m(this,n,t)},Date.prototype.diff=function(n,t){return x(this,n,t)},Date.prototype.format=function(){return function P(n){const t=c.time(n),e=t.getFullYear(),i=t.getMonth()+1,s=t.getDate(),r=t.getHours(),a=t.getMinutes(),o=t.getSeconds();return`${e}-${v(i)}-${v(s)} ${v(r)}:${v(a)}:${v(o)}`}(this)},Date.prototype.dueFormat=function(n,t,e){return function q(n,t,e,i=I){n=c.time(n),t=c.time(t),i.length!==I.length&&(i=I);let s=n.getTime()-t.getTime(),r=0;for(s/=1e3,r=0;r<F.length&&!(s<F[r]);r++)s/=F[r];return`${Math.floor(s)}${e?i[r]:""}`}(this,n,t,e)};const F=[60,60,24,31,12],I=["second","min","hour","day","month","year"],Y=Object.freeze([l.Again,l.Hard,l.Good,l.Easy]),j=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function g(n,t,e){return Math.min(Math.max(n,t),e)}const Z=n=>{const t=n.slice(-1),e=parseInt(n.slice(0,-1),10);if(Number.isNaN(e)||!Number.isFinite(e)||e<0)throw new Error(`Invalid step value: ${n}`);switch(t){case"m":return e;case"h":return 60*e;case"d":return 1440*e;default:throw new Error(`Invalid step unit: ${n}, expected m/h/d`)}},K=(n,t,e)=>{const i=t===u.Relearning||t===u.Review?n.relearning_steps:n.learning_steps,s=i.length;if(0===s||e>=s)return{};const r=i[0],a=Z,h=()=>{if(1===s)return Math.round(1.5*a(r));const f=i[1];return Math.round((a(r)+a(f))/2)},d=f=>f<0||f>=s?null:i[f],y={},w=d(Math.max(0,e));if(t===u.Review)return y[l.Again]={scheduled_minutes:a(w),next_step:0},y;{y[l.Again]={scheduled_minutes:a(r),next_step:0},y[l.Hard]={scheduled_minutes:h(),next_step:e};const f=d(e+1);if(f){const b=(f=>a(f))(f);b&&(y[l.Good]={scheduled_minutes:Math.round(b),next_step:e+1})}}return y};function X(){return`${this.review_time.getTime()}_${this.current.reps}_${this.current.difficulty*this.current.stability}`}var S=(n=>(n.SCHEDULER="Scheduler",n.LEARNING_STEPS="LearningSteps",n.SEED="Seed",n))(S||{});class G{last;current;review_time;next=new Map;algorithm;strategies;elapsed_days=0;constructor(t,e,i,s){this.algorithm=i,this.last=c.card(t),this.current=c.card(t),this.review_time=c.time(e),this.strategies=s,this.init()}checkGrade(t){if(!Number.isFinite(t)||t<0||t>4)throw new Error(`Invalid grade "${t}",expected 1-4`)}init(){const{state:t,last_review:e}=this.current;let i=0;t!==u.New&&e&&(i=function W(n,t){const e=Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()),i=Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate());return Math.floor((i-e)/864e5)}(e,this.review_time)),this.current.last_review=this.review_time,this.elapsed_days=i,this.current.elapsed_days=i,this.current.reps+=1;let s=X;if(this.strategies){const r=this.strategies.get(S.SEED);r&&(s=r)}this.algorithm.seed=s.call(this)}preview(){return{[l.Again]:this.review(l.Again),[l.Hard]:this.review(l.Hard),[l.Good]:this.review(l.Good),[l.Easy]:this.review(l.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(const t of Y)yield this.review(t)}review(t){const{state:e}=this.last;let i;switch(this.checkGrade(t),e){case u.New:i=this.newState(t);break;case u.Learning:case u.Relearning:i=this.learningState(t);break;case u.Review:i=this.reviewState(t)}return i}buildLog(t){const{last_review:e,due:i,elapsed_days:s}=this.last;return{rating:t,state:this.current.state,due:e||i,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.elapsed_days,last_elapsed_days:s,scheduled_days:this.current.scheduled_days,learning_steps:this.current.learning_steps,review:this.review_time}}}class V{c;s0;s1;s2;constructor(t){const e=function J(){let n=4022871197;return function(e){e=String(e);for(let i=0;i<e.length;i++){n+=e.charCodeAt(i);let s=.02519603282416938*n;n=s>>>0,s-=n,s*=n,n=s>>>0,s-=n,n+=4294967296*s}return 2.3283064365386963e-10*(n>>>0)}}();this.c=1,this.s0=e(" "),this.s1=e(" "),this.s2=e(" "),null==t&&(t=Date.now()),this.s0-=e(t),this.s0<0&&(this.s0+=1),this.s1-=e(t),this.s1<0&&(this.s1+=1),this.s2-=e(t),this.s2<0&&(this.s2+=1)}next(){const t=2091639*this.s0+2.3283064365386963e-10*this.c;return this.s0=this.s1,this.s1=this.s2,this.c=0|t,this.s2=t-this.c,this.s2}set state(t){this.c=t.c,this.s0=t.s0,this.s1=t.s1,this.s2=t.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}}const E=!0,st=Object.freeze(["1m","10m"]),rt=Object.freeze(["10m"]),p=.001,A=100,k=Object.freeze([.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,.1542]),R=(n,t,e=E)=>{let i=2;return Math.max(0,t)>1&&(i=g(+(-(Math.log(n[11])+Math.log(Math.pow(2,n[13])-1)+.3*n[14])/t).toFixed(8),.01,2)),((n,t=E)=>[[p,A],[p,A],[p,A],[p,A],[1,10],[.001,4],[.001,4],[.001,.75],[0,4.5],[0,.8],[.001,3.5],[.001,5],[.001,.25],[.001,.9],[0,4],[0,1],[1,6],[0,n],[0,n],[t?.01:0,.8],[.1,.8]])(i,e).slice(0,n.length).map(([r,a],o)=>g(n[o]||0,r,a))},D=(n,t=0,e=E)=>{if(void 0===n)return[...k];switch(n.length){case 21:return R(Array.from(n),t,e);case 19:return console.debug("[FSRS-6]auto fill w from 19 to 21 length"),R(Array.from(n),t,e).concat([0,.5]);case 17:{const i=R(Array.from(n),t,e);return i[4]=+(2*i[5]+i[4]).toFixed(8),i[5]=+(Math.log(3*i[5]+1)/3).toFixed(8),i[6]=+(i[6]+.5).toFixed(8),console.debug("[FSRS-6]auto fill w from 17 to 21 length"),i.concat([0,0,0,.5])}default:return console.warn("[FSRS]Invalid parameters length, using default parameters"),[...k]}},z=n=>{const t=Array.isArray(n?.learning_steps)?n.learning_steps:st,e=Array.isArray(n?.relearning_steps)?n.relearning_steps:rt,i=n?.enable_short_term??E,s=D(n?.w,e.length,i);return{request_retention:n?.request_retention||.9,maximum_interval:n?.maximum_interval||36500,w:s,enable_fuzz:n?.enable_fuzz??!1,enable_short_term:i,learning_steps:t,relearning_steps:e}};function L(n,t){const e={due:n?c.time(n):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,learning_steps:0,state:u.New,last_review:void 0};return t&&"function"==typeof t?t(e):e}const H=n=>{const t="number"==typeof n?-n:-n[20];return{decay:t,factor:+(Math.exp(Math.pow(t,-1)*Math.log(.9))-1).toFixed(8)}};function $(n,t,e){const{decay:i,factor:s}=H(n);return+Math.pow(1+s*t/e,i).toFixed(8)}class lt{param;intervalModifier;_seed;constructor(t){this.param=new Proxy(z(t),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention),this.forgetting_curve=$.bind(this,this.param.w)}get interval_modifier(){return this.intervalModifier}set seed(t){this._seed=t}calculate_interval_modifier(t){if(t<=0||t>1)throw new Error("Requested retention rate should be in the range (0,1]");const{decay:e,factor:i}=H(this.param.w);return+((Math.pow(t,1/e)-1)/i).toFixed(8)}get parameters(){return this.param}set parameters(t){this.update_parameters(t)}params_handler_proxy(){const t=this;return{set:function(e,i,s){return"request_retention"===i&&Number.isFinite(s)?t.intervalModifier=t.calculate_interval_modifier(Number(s)):"w"===i&&(s=D(s,e.relearning_steps.length,e.enable_short_term),t.forgetting_curve=$.bind(this,s),t.intervalModifier=t.calculate_interval_modifier(Number(e.request_retention))),Reflect.set(e,i,s),!0}}}update_parameters(t){const e=z(t);for(const i in e)this.param[i]=e[i]}init_stability(t){return Math.max(this.param.w[t-1],.1)}init_difficulty(t){return+(this.param.w[4]-Math.exp((t-1)*this.param.w[5])+1).toFixed(8)}apply_fuzz(t,e){if(!this.param.enable_fuzz||t<2.5)return Math.round(t);const s=function Q(n){const t=new V(n),e=()=>t.next();return e.int32=()=>4294967296*t.next()|0,e.double=()=>e()+11102230246251565e-32*(2097152*e()|0),e.state=()=>t.state,e.importState=i=>(t.state=i,e),e}(this._seed)(),{min_ivl:r,max_ivl:a}=function B(n,t,e){let i=1;for(const a of j)i+=a.factor*Math.max(Math.min(n,a.end)-a.start,0);n=Math.min(n,e);let s=Math.max(2,Math.round(n-i));const r=Math.min(Math.round(n+i),e);return n>t&&(s=Math.max(s,t+1)),s=Math.min(s,r),{min_ivl:s,max_ivl:r}}(t,e,this.param.maximum_interval);return Math.floor(s*(a-r+1)+r)}next_interval(t,e){const i=Math.min(Math.max(1,Math.round(t*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(i,e)}linear_damping(t,e){return+(t*(10-e)/9).toFixed(8)}next_difficulty(t,e){const s=t+this.linear_damping(-this.param.w[6]*(e-3),t);return g(this.mean_reversion(this.init_difficulty(l.Easy),s),1,10)}mean_reversion(t,e){return+(this.param.w[7]*t+(1-this.param.w[7])*e).toFixed(8)}next_recall_stability(t,e,i,s){const r=l.Hard===s?this.param.w[15]:1,a=l.Easy===s?this.param.w[16]:1;return+g(e*(1+Math.exp(this.param.w[8])*(11-t)*Math.pow(e,-this.param.w[9])*(Math.exp((1-i)*this.param.w[10])-1)*r*a),p,36500).toFixed(8)}next_forget_stability(t,e,i){return+g(this.param.w[11]*Math.pow(t,-this.param.w[12])*(Math.pow(e+1,this.param.w[13])-1)*Math.exp((1-i)*this.param.w[14]),p,36500).toFixed(8)}next_short_term_stability(t,e){const i=Math.pow(t,-this.param.w[19])*Math.exp(this.param.w[17]*(e-3+this.param.w[18]));return+g(t*(e>=3?Math.max(i,1):i),p,36500).toFixed(8)}forgetting_curve;next_state(t,e,i){const{difficulty:s,stability:r}=t??{difficulty:0,stability:0};if(e<0)throw new Error(`Invalid delta_t "${e}"`);if(i<0||i>4)throw new Error(`Invalid grade "${i}"`);if(0===s&&0===r)return{difficulty:g(this.init_difficulty(i),1,10),stability:this.init_stability(i)};if(0===i)return{difficulty:s,stability:r};if(s<1||r<p)throw new Error(`Invalid memory state { difficulty: ${s}, stability: ${r} }`);const a=this.forgetting_curve(e,r),o=this.next_recall_stability(s,r,a,i),h=this.next_forget_stability(s,r,a),d=this.next_short_term_stability(r,i);let _=o;if(1===i){let[w,f]=[0,0];this.param.enable_short_term&&(w=this.param.w[17],f=this.param.w[18]),_=g(+(r/Math.exp(w*f)).toFixed(8),p,h)}return 0===e&&this.param.enable_short_term&&(_=d),{difficulty:this.next_difficulty(s,i),stability:_}}}class U extends G{learningStepsStrategy;constructor(t,e,i,s){super(t,e,i,s);let r=K;if(this.strategies){const a=this.strategies.get(S.LEARNING_STEPS);a&&(r=a)}this.learningStepsStrategy=r}getLearningInfo(t,e){const i=this.algorithm.parameters;t.learning_steps=t.learning_steps||0;const s=this.learningStepsStrategy(i,t.state,this.current.state===u.Learning&&e!==l.Again&&e!==l.Hard?t.learning_steps+1:t.learning_steps);return{scheduled_minutes:Math.max(0,s[e]?.scheduled_minutes??0),next_steps:Math.max(0,s[e]?.next_step??0)}}applyLearningSteps(t,e,i){const{scheduled_minutes:s,next_steps:r}=this.getLearningInfo(this.current,e);if(s>0&&s<1440)t.learning_steps=r,t.scheduled_days=0,t.state=i,t.due=m(this.review_time,Math.round(s),!1);else if(t.state=u.Review,s>=1440)t.learning_steps=r,t.due=m(this.review_time,Math.round(s),!1),t.scheduled_days=Math.floor(s/1440);else{t.learning_steps=0;const a=this.algorithm.next_interval(t.stability,this.elapsed_days);t.scheduled_days=a,t.due=m(this.review_time,a,!0)}}newState(t){const e=this.next.get(t);if(e)return e;const i=c.card(this.current);i.difficulty=g(this.algorithm.init_difficulty(t),1,10),i.stability=this.algorithm.init_stability(t),this.applyLearningSteps(i,t,u.Learning);const s={card:i,log:this.buildLog(t)};return this.next.set(t,s),s}learningState(t){const e=this.next.get(t);if(e)return e;const{state:i,difficulty:s,stability:r}=this.last,a=c.card(this.current);a.difficulty=this.algorithm.next_difficulty(s,t),a.stability=this.algorithm.next_short_term_stability(r,t),this.applyLearningSteps(a,t,i);const o={card:a,log:this.buildLog(t)};return this.next.set(t,o),o}reviewState(t){const e=this.next.get(t);if(e)return e;const i=this.elapsed_days,{difficulty:s,stability:r}=this.last,a=this.algorithm.forgetting_curve(i,r),o=c.card(this.current),h=c.card(this.current),d=c.card(this.current),_=c.card(this.current);this.next_ds(o,h,d,_,s,r,a),this.next_interval(h,d,_,i),this.next_state(h,d,_),this.applyLearningSteps(o,l.Again,u.Relearning),o.lapses+=1;const y={card:o,log:this.buildLog(l.Again)},w={card:h,log:super.buildLog(l.Hard)},f={card:d,log:super.buildLog(l.Good)},b={card:_,log:super.buildLog(l.Easy)};return this.next.set(l.Again,y),this.next.set(l.Hard,w),this.next.set(l.Good,f),this.next.set(l.Easy,b),this.next.get(t)}next_ds(t,e,i,s,r,a,o){t.difficulty=this.algorithm.next_difficulty(r,l.Again);const h=a/Math.exp(this.algorithm.parameters.w[17]*this.algorithm.parameters.w[18]),d=this.algorithm.next_forget_stability(r,a,o);t.stability=g(+h.toFixed(8),p,d),e.difficulty=this.algorithm.next_difficulty(r,l.Hard),e.stability=this.algorithm.next_recall_stability(r,a,o,l.Hard),i.difficulty=this.algorithm.next_difficulty(r,l.Good),i.stability=this.algorithm.next_recall_stability(r,a,o,l.Good),s.difficulty=this.algorithm.next_difficulty(r,l.Easy),s.stability=this.algorithm.next_recall_stability(r,a,o,l.Easy)}next_interval(t,e,i,s){let r,a;r=this.algorithm.next_interval(t.stability,s),a=this.algorithm.next_interval(e.stability,s),r=Math.min(r,a),a=Math.max(a,r+1);const o=Math.max(this.algorithm.next_interval(i.stability,s),a+1);t.scheduled_days=r,t.due=m(this.review_time,r,!0),e.scheduled_days=a,e.due=m(this.review_time,a,!0),i.scheduled_days=o,i.due=m(this.review_time,o,!0)}next_state(t,e,i){t.state=u.Review,t.learning_steps=0,e.state=u.Review,e.learning_steps=0,i.state=u.Review,i.learning_steps=0}}class C extends G{newState(t){const e=this.next.get(t);if(e)return e;this.current.scheduled_days=0,this.current.elapsed_days=0;const i=c.card(this.current),s=c.card(this.current),r=c.card(this.current),a=c.card(this.current);return this.init_ds(i,s,r,a),this.next_interval(i,s,r,a,0),this.next_state(i,s,r,a),this.update_next(i,s,r,a),this.next.get(t)}init_ds(t,e,i,s){t.difficulty=g(this.algorithm.init_difficulty(l.Again),1,10),t.stability=this.algorithm.init_stability(l.Again),e.difficulty=g(this.algorithm.init_difficulty(l.Hard),1,10),e.stability=this.algorithm.init_stability(l.Hard),i.difficulty=g(this.algorithm.init_difficulty(l.Good),1,10),i.stability=this.algorithm.init_stability(l.Good),s.difficulty=g(this.algorithm.init_difficulty(l.Easy),1,10),s.stability=this.algorithm.init_stability(l.Easy)}learningState(t){return this.reviewState(t)}reviewState(t){const e=this.next.get(t);if(e)return e;const i=this.elapsed_days,{difficulty:s,stability:r}=this.last,a=this.algorithm.forgetting_curve(i,r),o=c.card(this.current),h=c.card(this.current),d=c.card(this.current),_=c.card(this.current);return this.next_ds(o,h,d,_,s,r,a),this.next_interval(o,h,d,_,i),this.next_state(o,h,d,_),o.lapses+=1,this.update_next(o,h,d,_),this.next.get(t)}next_ds(t,e,i,s,r,a,o){t.difficulty=this.algorithm.next_difficulty(r,l.Again);const h=this.algorithm.next_forget_stability(r,a,o);t.stability=g(a,p,h),e.difficulty=this.algorithm.next_difficulty(r,l.Hard),e.stability=this.algorithm.next_recall_stability(r,a,o,l.Hard),i.difficulty=this.algorithm.next_difficulty(r,l.Good),i.stability=this.algorithm.next_recall_stability(r,a,o,l.Good),s.difficulty=this.algorithm.next_difficulty(r,l.Easy),s.stability=this.algorithm.next_recall_stability(r,a,o,l.Easy)}next_interval(t,e,i,s,r){let a,o,h,d;a=this.algorithm.next_interval(t.stability,r),o=this.algorithm.next_interval(e.stability,r),h=this.algorithm.next_interval(i.stability,r),d=this.algorithm.next_interval(s.stability,r),a=Math.min(a,o),o=Math.max(o,a+1),h=Math.max(h,o+1),d=Math.max(d,h+1),t.scheduled_days=a,t.due=m(this.review_time,a,!0),e.scheduled_days=o,e.due=m(this.review_time,o,!0),i.scheduled_days=h,i.due=m(this.review_time,h,!0),s.scheduled_days=d,s.due=m(this.review_time,d,!0)}next_state(t,e,i,s){t.state=u.Review,t.learning_steps=0,e.state=u.Review,e.learning_steps=0,i.state=u.Review,i.learning_steps=0,s.state=u.Review,s.learning_steps=0}update_next(t,e,i,s){const r={card:t,log:this.buildLog(l.Again)},a={card:e,log:super.buildLog(l.Hard)},o={card:i,log:super.buildLog(l.Good)},h={card:s,log:super.buildLog(l.Easy)};this.next.set(l.Again,r),this.next.set(l.Hard,a),this.next.set(l.Good,o),this.next.set(l.Easy,h)}}class ot{fsrs;constructor(t){this.fsrs=t}replay(t,e,i){return this.fsrs.next(t,e,i)}handleManualRating(t,e,i,s,r,a,o){if(typeof e>"u")throw new Error("reschedule: state is required for manual rating");let h,d;if(e===u.New)h={rating:l.Manual,state:e,due:o??i,stability:t.stability,difficulty:t.difficulty,elapsed_days:s,last_elapsed_days:t.elapsed_days,scheduled_days:t.scheduled_days,learning_steps:t.learning_steps,review:i},d=L(i),d.last_review=i;else{if(typeof o>"u")throw new Error("reschedule: due is required for manual rating");const _=x(o,i,"days");h={rating:l.Manual,state:t.state,due:t.last_review||t.due,stability:t.stability,difficulty:t.difficulty,elapsed_days:s,last_elapsed_days:t.elapsed_days,scheduled_days:t.scheduled_days,learning_steps:t.learning_steps,review:i},d={...t,state:e,due:o,last_review:i,stability:r||t.stability,difficulty:a||t.difficulty,elapsed_days:s,scheduled_days:_,reps:t.reps+1}}return{card:d,log:h}}reschedule(t,e){const i=[];let s=L(t.due);for(const r of e){let a;if(r.review=c.time(r.review),r.rating===l.Manual){let o=0;s.state!==u.New&&s.last_review&&(o=x(r.review,s.last_review,"days")),a=this.handleManualRating(s,r.state,r.review,o,r.stability,r.difficulty,r.due?c.time(r.due):void 0)}else a=this.replay(s,r.review,r.rating);i.push(a),s=a.card}return i}calculateManualRecord(t,e,i,s){if(!i)return null;const{card:r,log:a}=i,o=c.card(t);return o.due.getTime()===r.due.getTime()?null:(o.scheduled_days=x(r.due,o.due,"days"),this.handleManualRating(o,r.state,c.time(e),a.elapsed_days,s?r.stability:void 0,s?r.difficulty:void 0,r.due))}}class ct extends lt{strategyHandler=new Map;Scheduler;constructor(t){super(t);const{enable_short_term:e}=this.parameters;this.Scheduler=e?U:C}params_handler_proxy(){const t=this;return{set:function(e,i,s){return"request_retention"===i&&Number.isFinite(s)?t.intervalModifier=t.calculate_interval_modifier(Number(s)):"enable_short_term"===i?t.Scheduler=!0===s?U:C:"w"===i&&(s=D(s,e.relearning_steps.length,e.enable_short_term),t.forgetting_curve=$.bind(this,s),t.intervalModifier=t.calculate_interval_modifier(Number(e.request_retention))),Reflect.set(e,i,s),!0}}}useStrategy(t,e){return this.strategyHandler.set(t,e),this}clearStrategy(t){return t?this.strategyHandler.delete(t):this.strategyHandler.clear(),this}getScheduler(t,e){return new(this.strategyHandler.get(S.SCHEDULER)||this.Scheduler)(t,e,this,this.strategyHandler)}repeat(t,e,i){const r=this.getScheduler(t,e).preview();return i&&"function"==typeof i?i(r):r}next(t,e,i,s){const r=this.getScheduler(t,e),a=c.rating(i);if(a===l.Manual)throw new Error("Cannot review a manual rating");const o=r.review(a);return s&&"function"==typeof s?s(o):o}get_retrievability(t,e,i=!0){const s=c.card(t);e=e?c.time(e):new Date;const r=s.state!==u.New?Math.max(x(e,s.last_review,"days"),0):0,a=s.state!==u.New?this.forgetting_curve(r,+s.stability.toFixed(8)):0;return i?`${(100*a).toFixed(2)}%`:a}rollback(t,e,i){const s=c.card(t),r=c.review_log(e);if(r.rating===l.Manual)throw new Error("Cannot rollback a manual rating");let a,o,h;switch(r.state){case u.New:a=r.due,o=void 0,h=0;break;case u.Learning:case u.Relearning:case u.Review:a=r.review,o=r.due,h=s.lapses-(r.rating===l.Again&&r.state===u.Review?1:0)}const d={...s,due:a,stability:r.stability,difficulty:r.difficulty,elapsed_days:r.last_elapsed_days,scheduled_days:r.scheduled_days,reps:Math.max(0,s.reps-1),lapses:Math.max(0,h),learning_steps:r.learning_steps,state:r.state,last_review:o};return i&&"function"==typeof i?i(d):d}forget(t,e,i=!1,s){const r=c.card(t);e=c.time(e);const a=r.state===u.New?0:x(e,r.due,"days"),o={rating:l.Manual,state:r.state,due:r.due,stability:r.stability,difficulty:r.difficulty,elapsed_days:0,last_elapsed_days:r.elapsed_days,scheduled_days:a,learning_steps:r.learning_steps,review:e},d={card:{...r,due:e,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:i?0:r.reps,lapses:i?0:r.lapses,learning_steps:0,state:u.New,last_review:r.last_review},log:o};return s&&"function"==typeof s?s(d):d}reschedule(t,e=[],i={}){const{recordLogHandler:s,reviewsOrderBy:r,skipManual:a=!0,now:o=new Date,update_memory_state:h=!1}=i;r&&"function"==typeof r&&e.sort(r),a&&(e=e.filter(b=>b.rating!==l.Manual));const d=new ot(this),_=d.reschedule(i.first_card||L(),e),y=_.length,w=c.card(t),f=d.calculateManualRecord(w,o,y?_[y-1]:void 0,h);return s&&"function"==typeof s?{collections:_.map(s),reschedule_item:f?s(f):null}:{collections:_,reschedule_item:f}}}const ht=n=>new ct(n||{})}}]);